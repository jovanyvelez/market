<div class="carrito-container">
    <h2>Mi Carrito de Compras</h2>

    <div id="cart-items" class="cart-items" data-server-rendered="true">
        {% if cart_items and cart_items|length > 0 %}
        {% for item in cart_items %}
        <div class="cart-item" data-product-id="{{ item.id }}">
            <div class="cart-item-image">
                {% if item.imageUrl and item.imageUrl.strip() != '' %}
                <img src="{{ item.imageUrl }}" alt="{{ item.name }}"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="default-image" style="display: none;">ðŸ“¦</div>
                {% else %}
                <div class="default-image">ðŸ“¦</div>
                {% endif %}
            </div>

            <div class="cart-item-info">
                <div class="cart-item-name">{{ item.name }}</div>
                <div class="cart-item-details">${{ "%.2f"|format(item.price) }} c/u</div>
            </div>

            <div class="cart-item-controls">
                <div class="quantity-controls">
                    <button class="quantity-btn decrease-btn" data-product-id="{{ item.id }}">-</button>
                    <span class="quantity-display" id="quantityDisplay_{{ item.id }}">{{ item.quantity }}</span>
                    <button class="quantity-btn increase-btn" data-product-id="{{ item.id }}">+</button>
                </div>
                <button class="remove-btn" onclick="removeFromCart({{ item.id }})">Eliminar</button>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-cart">Tu carrito estÃ¡ vacÃ­o</div>
        {% endif %}
    </div>

    <div class="cart-total-section">
        <div class="cart-total">
            <strong>Total: $</strong><span id="cart-total">
                {% if cart_items and cart_items|length > 0 %}
                {% set total = 0 %}
                {% for item in cart_items %}
                {% set total = total + (item.price * item.quantity) %}
                {% endfor %}
                {{ "%.2f"|format(total) }}
                {% else %}
                0.00
                {% endif %}
            </span>
        </div>

        {% if cart_items and cart_items|length > 0 %}
        <form action="/checkout" method="post">
            {% for item in cart_items %}
            <!-- Campos ocultos para enviar datos del carrito -->
            <input type="hidden" name="items[{{ loop.index0 }}][id]" value="{{ item.id }}">
            <input type="hidden" name="items[{{ loop.index0 }}][name]" value="{{ item.name }}">
            <input type="hidden" name="items[{{ loop.index0 }}][price]" value="{{ item.price }}">
            <input type="hidden" name="items[{{ loop.index0 }}][quantity]" value="{{ item.quantity }}">
            {% if item.imageUrl %}
            <input type="hidden" name="items[{{ loop.index0 }}][imageUrl]" value="{{ item.imageUrl }}">
            {% endif %}
            {% endfor %}

            <button id="checkout-btn" class="checkout-btn" type="submit">
                Finalizar Compra
            </button>
        </form>
        {% else %}
        <button id="checkout-btn" class="checkout-btn" disabled>
            Finalizar Compra
        </button>
        {% endif %}
    </div>

    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}

    {% if success_message %}
    <div class="success-message">{{ success_message }}</div>
    {% endif %}

    <div id="notification" class="notification"></div>
</div>

<script>
// Script para integrar con carrito.js existente
document.addEventListener('DOMContentLoaded', function () {
    console.log('Template de carrito cargado desde FastAPI');
    
    // Sincronizar localStorage con los datos del servidor
    const cartItems = [
        {% for item in cart_items %}
        {
            id: {{ item.id }},
            name: "{{ item.name|e }}",
            price: {{ item.price }},
            quantity: {{ item.quantity }}{% if item.imageUrl %},
            imageUrl: "{{ item.imageUrl|e }}"{% endif %}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Actualizar la variable global cart con los datos del servidor
    if (typeof window !== 'undefined') {
        window.cart = cartItems;
        cart = cartItems; // TambiÃ©n actualizar la variable local
        localStorage.setItem('shoppingCart', JSON.stringify(cartItems));
        console.log('Carrito sincronizado con datos del servidor:', cartItems);
        
        // Actualizar el contador
        if (typeof updateCartCount === 'function') {
            updateCartCount();
        }
    }
});
</script>

