<div class="carrito-container">
    <h2>Mi Carrito de Compras</h2>
    
    <div id="cart-items" class="cart-items">
        {% if is_empty %}
            <div class="empty-cart">Tu carrito estÃ¡ vacÃ­o</div>
        {% else %}
            {% for item in cart_items %}
            <div class="cart-item">
                <div class="cart-item-image">
                    {% if item.imageUrl and item.imageUrl != '/static/default-product.png' %}
                        <img src="{{ item.imageUrl }}" alt="{{ item.name }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="default-image" style="display: none;">ðŸ“¦</div>
                    {% else %}
                        <div class="default-image">ðŸ“¦</div>
                    {% endif %}
                </div>
                <div class="cart-item-info">
                    <div class="cart-item-name">{{ item.name }}</div>
                    <div class="cart-item-details">${{ "%.2f"|format(item.price) }} c/u</div>
                </div>
                <div class="cart-item-controls">
                    <div class="quantity-controls">
                        <button class="quantity-btn decrease-btn" data-product-id="{{ item.id }}">-</button>
                        <span class="quantity-display" id="quantityDisplay_{{ item.id }}">{{ item.quantity }}</span>
                        <button class="quantity-btn increase-btn" data-product-id="{{ item.id }}">+</button>
                    </div>
                    <button class="remove-btn" onclick="removeFromCart('{{ item.id }}')">Eliminar</button>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>
    
    <div class="cart-total-section">
        <div class="cart-total">
            <strong>Total: $</strong><span id="cart-total">{{ "%.2f"|format(total) }}</span>
        </div>
        <button id="checkout-btn" class="checkout-btn" onclick="checkout()" {% if is_empty %}disabled{% endif %}>
            Finalizar Compra
        </button>
    </div>
    
    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}
    
    <div id="notification" class="notification"></div>
</div>

<script>
// FunciÃ³n para enviar el carrito al backend
function sendCartToBackend() {
    if (!window.cart || cart.length === 0) {
        // Si el carrito estÃ¡ vacÃ­o, usar GET
        htmx.ajax('GET', '/api/v2/categorias/carrito', {target: '#reemplazar'});
        return;
    }
    
    // Enviar datos del carrito al backend via POST
    fetch('/api/v2/categorias/carrito', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            items: cart
        })
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('reemplazar').innerHTML = html;
    })
    .catch(error => {
        console.error('Error enviando carrito:', error);
        // Fallback a GET si hay error
        htmx.ajax('GET', '/api/v2/categorias/carrito', {target: '#reemplazar'});
    });
}

// Cargar el carrito cuando se muestre esta vista
document.addEventListener('DOMContentLoaded', function() {
    if (typeof updateCartDisplay === 'function') {
        updateCartDisplay();
    }
});

// TambiÃ©n ejecutar cuando HTMX carga esta vista
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.target.id === 'reemplazar') {
        setTimeout(function() {
            if (typeof updateCartDisplay === 'function') {
                updateCartDisplay();
            }
        }, 100);
    }
});
</script>